---
layout: post
title: Blog Post 1 - Working with Databases
---

In this blog post, I will be creating interactive data graphics using the NOAA climate data. Specifically, I will be focusing on the [Global Historical Climatology Network Monthly](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-monthly-version-4) data set, which is a set of monthly climate summaries from thousands of weather stations across the world. 

First, let's briefly look at the data that we are loading in. The NOAA-GHCN data is 135.1 MB. While this is not too much memory, it is large enough such that it may take a while to load in as a `pandas` DataFrame. As a result, in addition to `pandas`, I will be using `sqlite3` to load in our data as a database.

### ยง1. Create a Database
First let's load in our smaller data:
-  `stations`: contains the station's ID, name, and geographical coordinates 
- `countries`: contains the country's name and associated FIPS 10-4 and ISO3166 code
```python
import pandas as pd
stations = pd.read_csv("https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv")
countries = pd.read_csv("https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv")
```
Here's a brief snippet at what each data set looks like:
```python
stations.head()
```
**Insert markdown file of `stations.head()`**
```python
countries.head()
```
**Insert markdown file of `countries.head()`**

Now, let's take a look at our larger NOAA-GHCN data:\
Naively, we will use the `pandas` method just to see what our data looks like. 
```python
temps = pd.read_csv("temps.csv")
temps.head()
```
**Insert markdown file of `temps.head()`**

Great, but let's do some data prepping with our NOAA-GHCN data set to make it easier to work with. Specficially, instead of having columns for each month for a specific year, we want to add these as entries for a certain station. Here's a function that will handle that:
```python
def prepare_df(df):
    """
    Prepares the temps df  such that the columns corresponding 
    to each month for a year are now entries for a particular station
    """
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100 # data is given as 
    return(df)
```
\
Since, the NOAA-GHCN data is larger and is slow to load in with `pandas`, we will use the `sqlite3` package to create a `temps` database. The following lines of code imports the `sqlite3` package as well as instantiates a connection to an empty database called `temps.db`\
\
```python
import sqlite3
conn = sqlite3.connect("temps.db")
```
Finally, we can populate our `temps` database with the three different tables. 
```python
df_iter = pd.read_csv("temps.csv", chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False) # take pandas df and turn them into table objects in database
    
# temps.db is the name of the database
# temperatures is the name of the table in the database
```
```python
stations.to_sql("stations", conn, if_exists = "replace", index = False)
```
```python
countries.to_sql("countries", conn, if_exists = "replace", index = False)
```
### ยง2. Write a Query Function
