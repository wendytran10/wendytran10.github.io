---
layout: post
title: Blog Post 1 - Working with Databases
---

In this blog post, I will be creating interactive data graphics using the NOAA climate data. Specifically, I will be focusing on the [Global Historical Climatology Network Monthly](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-monthly-version-4) data set, which is a set of monthly climate summaries from thousands of weather stations across the world. 

First, let's briefly look at the data that we are loading in. The NOAA-GHCN data is 135.1 MB. While this is not too much memory, it is large enough such that it may take a while to load in as a `pandas` DataFrame. As a result, in addition to `pandas`, I will be using `sqlite3` to load in our data as a database.

### §1. Create a Database
First let's load in our smaller data:
-  `stations`: contains the station's ID, name, and geographical coordinates 
- `countries`: contains the country's name and associated FIPS 10-4 and ISO3166 code
```python
import pandas as pd
stations = pd.read_csv("https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv")
countries = pd.read_csv("https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv")
```
Here's a brief snippet at what each data set looks like:
```python
stations.head()
```
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>STNELEV</th>
      <th>NAME</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>57.7667</td>
      <td>11.8667</td>
      <td>18.0</td>
      <td>SAVE</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AE000041196</td>
      <td>25.3330</td>
      <td>55.5170</td>
      <td>34.0</td>
      <td>SHARJAH_INTER_AIRP</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AEM00041184</td>
      <td>25.6170</td>
      <td>55.9330</td>
      <td>31.0</td>
      <td>RAS_AL_KHAIMAH_INTE</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AEM00041194</td>
      <td>25.2550</td>
      <td>55.3640</td>
      <td>10.4</td>
      <td>DUBAI_INTL</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AEM00041216</td>
      <td>24.4300</td>
      <td>54.4700</td>
      <td>3.0</td>
      <td>ABU_DHABI_BATEEN_AIR</td>
    </tr>
  </tbody>
</table>
</div>

```python
countries.head()
```
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FIPS 10-4</th>
      <th>ISO 3166</th>
      <th>Name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AF</td>
      <td>AF</td>
      <td>Afghanistan</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AX</td>
      <td>-</td>
      <td>Akrotiri</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL</td>
      <td>AL</td>
      <td>Albania</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AG</td>
      <td>DZ</td>
      <td>Algeria</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AQ</td>
      <td>AS</td>
      <td>American Samoa</td>
    </tr>
  </tbody>
</table>
</div>


Notice that both the `stations` and `countries` DataFrame have a `Name` column. To make things more clear, we will change the name of `Name` in the `countries` DataFrame:
```python
countries = countries.rename(columns={"Name": "Country"})
countries.head()
```
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FIPS 10-4</th>
      <th>ISO 3166</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AF</td>
      <td>AF</td>
      <td>Afghanistan</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AX</td>
      <td>-</td>
      <td>Akrotiri</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AL</td>
      <td>AL</td>
      <td>Albania</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AG</td>
      <td>DZ</td>
      <td>Algeria</td>
    </tr>
    <tr>
      <th>4</th>
      <td>AQ</td>
      <td>AS</td>
      <td>American Samoa</td>
    </tr>
  </tbody>
</table>
</div>


Now, let's take a look at our larger NOAA-GHCN data:\
Naively, we will use the `pandas` method just to see what our data looks like. 
```python
temps = pd.read_csv("temps.csv")
temps.head()
```
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>VALUE1</th>
      <th>VALUE2</th>
      <th>VALUE3</th>
      <th>VALUE4</th>
      <th>VALUE5</th>
      <th>VALUE6</th>
      <th>VALUE7</th>
      <th>VALUE8</th>
      <th>VALUE9</th>
      <th>VALUE10</th>
      <th>VALUE11</th>
      <th>VALUE12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>-89.0</td>
      <td>236.0</td>
      <td>472.0</td>
      <td>773.0</td>
      <td>1128.0</td>
      <td>1599.0</td>
      <td>1570.0</td>
      <td>1481.0</td>
      <td>1413.0</td>
      <td>1174.0</td>
      <td>510.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1962</td>
      <td>113.0</td>
      <td>85.0</td>
      <td>-154.0</td>
      <td>635.0</td>
      <td>908.0</td>
      <td>1381.0</td>
      <td>1510.0</td>
      <td>1393.0</td>
      <td>1163.0</td>
      <td>994.0</td>
      <td>323.0</td>
      <td>-126.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1963</td>
      <td>-713.0</td>
      <td>-553.0</td>
      <td>-99.0</td>
      <td>541.0</td>
      <td>1224.0</td>
      <td>1627.0</td>
      <td>1620.0</td>
      <td>1596.0</td>
      <td>1332.0</td>
      <td>940.0</td>
      <td>566.0</td>
      <td>-108.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1964</td>
      <td>62.0</td>
      <td>-85.0</td>
      <td>55.0</td>
      <td>738.0</td>
      <td>1219.0</td>
      <td>1442.0</td>
      <td>1506.0</td>
      <td>1557.0</td>
      <td>1221.0</td>
      <td>788.0</td>
      <td>546.0</td>
      <td>112.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1965</td>
      <td>44.0</td>
      <td>-105.0</td>
      <td>38.0</td>
      <td>590.0</td>
      <td>987.0</td>
      <td>1500.0</td>
      <td>1487.0</td>
      <td>1477.0</td>
      <td>1377.0</td>
      <td>974.0</td>
      <td>31.0</td>
      <td>-178.0</td>
    </tr>
  </tbody>
</table>
</div>


Great, but let's do some data prepping with our NOAA-GHCN data set to make it easier to work with. Specficially, instead of having columns for each month for a specific year, we want to add these as entries for a certain station. Here's a function that will handle that:
```python
def prepare_df(df):
    """
    Prepares the temps df  such that the columns corresponding 
    to each month for a year are now entries for a particular station
    """
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100 # data is given as 
    return(df)
```
```python
temps = prepare_df(temps)
temps.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>1</td>
      <td>-0.89</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>2</td>
      <td>2.36</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>3</td>
      <td>4.72</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>4</td>
      <td>7.73</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>5</td>
      <td>11.28</td>
    </tr>
  </tbody>
</table>
</div>


Since, the NOAA-GHCN data is larger and is slow to load in with `pandas`, we will use the `sqlite3` package to create a `temps` database. The following lines of code imports the `sqlite3` package as well as instantiates a connection to an empty database called `temps.db` 

```python
import sqlite3
conn = sqlite3.connect("temps.db")
```
Finally, we can populate our `temps` database with the three different tables. 
```python
df_iter = pd.read_csv("temps.csv", chunksize = 100000)
for df in df_iter:
    df = prepare_df(df)
    df.to_sql("temperatures", conn, if_exists = "append", index = False) # take pandas df and turn them into table objects in database
    
# temps.db is the name of the database
# temperatures is the name of the table in the database
```
```python
stations.to_sql("stations", conn, if_exists = "replace", index = False)
```
```python
countries.to_sql("countries", conn, if_exists = "replace", index = False)
```
Finally, let's close the connection to our `temps` database. 
```python
conn.close()
```
### §2. Write a Query Function
Cool! Now that we have our database, we can easily design a function to query the database for only a subset of the data that we are interested in. Here is a function to do that: 
```python
def query_climate_database(country, year_begin, year_end, month):
    """
    A function to query the database given user-inputted parameters including:
        - country: string giving the name of a country
        - year_begin & year_end: 2 integers giving the earliest and latest years
        - month: integer giving the month of the year 
        
    Returns a Pandas DataFrame of temperature reading given the user-inputted parameters
    """
    conn = sqlite3.connect("temps.db")
    cmd = \
    """
    SELECT S.name, S.latitude, S.longitude, C.country, T.year, T.month, T.temp 
    FROM stations S 
    LEFT JOIN temperatures T on T.id = S.id 
    LEFT JOIN countries C on substr(S.id, 1, 2) = C.`fips 10-4` 
    WHERE C.country == ? AND T.year >= ? AND T.year <= ? AND T.month == ?
    """
    df = pd.read_sql_query(cmd, conn, params = [country, year_begin, year_end, month])
    conn.close()
    
    return df
```

Let's say we wanted all the temperature readings at the different stations in India from 1980-2020 in the month of January. 
```python
query_climate_database(country = "India", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Country</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1981</td>
      <td>1</td>
      <td>24.57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1982</td>
      <td>1</td>
      <td>24.19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>23.51</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1984</td>
      <td>1</td>
      <td>24.81</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3147</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>5.10</td>
    </tr>
    <tr>
      <th>3148</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1986</td>
      <td>1</td>
      <td>6.90</td>
    </tr>
    <tr>
      <th>3149</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1994</td>
      <td>1</td>
      <td>8.10</td>
    </tr>
    <tr>
      <th>3150</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1995</td>
      <td>1</td>
      <td>5.60</td>
    </tr>
    <tr>
      <th>3151</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1997</td>
      <td>1</td>
      <td>5.70</td>
    </tr>
  </tbody>
</table>
<p>3152 rows × 7 columns</p>
</div>

Another example for Algeria:
```python
query_climate_database(country = "Algeria", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Name</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ALGER_DAR_EL_BEIDA</td>
      <td>36.7167</td>
      <td>3.25</td>
      <td>Algeria</td>
      <td>1980</td>
      <td>1</td>
      <td>10.40</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ALGER_DAR_EL_BEIDA</td>
      <td>36.7167</td>
      <td>3.25</td>
      <td>Algeria</td>
      <td>1981</td>
      <td>1</td>
      <td>8.93</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ALGER_DAR_EL_BEIDA</td>
      <td>36.7167</td>
      <td>3.25</td>
      <td>Algeria</td>
      <td>1982</td>
      <td>1</td>
      <td>11.74</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ALGER_DAR_EL_BEIDA</td>
      <td>36.7167</td>
      <td>3.25</td>
      <td>Algeria</td>
      <td>1983</td>
      <td>1</td>
      <td>8.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ALGER_DAR_EL_BEIDA</td>
      <td>36.7167</td>
      <td>3.25</td>
      <td>Algeria</td>
      <td>1984</td>
      <td>1</td>
      <td>10.54</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2446</th>
      <td>BEJAIA</td>
      <td>36.8000</td>
      <td>5.00</td>
      <td>Algeria</td>
      <td>2009</td>
      <td>1</td>
      <td>11.60</td>
    </tr>
    <tr>
      <th>2447</th>
      <td>BEJAIA</td>
      <td>36.8000</td>
      <td>5.00</td>
      <td>Algeria</td>
      <td>2010</td>
      <td>1</td>
      <td>12.20</td>
    </tr>
    <tr>
      <th>2448</th>
      <td>BEJAIA</td>
      <td>36.8000</td>
      <td>5.00</td>
      <td>Algeria</td>
      <td>2011</td>
      <td>1</td>
      <td>11.30</td>
    </tr>
    <tr>
      <th>2449</th>
      <td>BEJAIA</td>
      <td>36.8000</td>
      <td>5.00</td>
      <td>Algeria</td>
      <td>2012</td>
      <td>1</td>
      <td>10.40</td>
    </tr>
    <tr>
      <th>2450</th>
      <td>BEJAIA</td>
      <td>36.8000</td>
      <td>5.00</td>
      <td>Algeria</td>
      <td>2013</td>
      <td>1</td>
      <td>11.30</td>
    </tr>
  </tbody>
</table>
<p>2451 rows × 7 columns</p>
</div>


### §3. Data Visualizations
In this part, I will writes three functions to create visualizations that address the following questions:
> 1. How does the average yearly change in temperature vary within a given country? <br>
2. How has the average monthly and average yearly temperatures change over time within a given country?<br>
3. Where are the temperature measurements being collected within a given country?

To do this, I will use the `Plotly` library to construct these interactive graphics. Additionally, we will import the `calendar` package to make handling dates easier. Let's import these packages:
```python
from plotly import express as px
import calendar
```
We're ready to tackle the first question!
> How does the average yearly change in temperature vary within a given country? 

Using the `query_climate_database()` function that we wrote above, we can easily obtain the temperatures, stations, and country data in a DataFrame that pertains to a certain country during a certain time period. Since we also want to filter out the stations that do not have at least `min_obs` years worth of data, we will also be utilizing the `filter()` method of `pandas` DataFrames. Lastly, to calculate the "average yearly change in temperature," we can use linear regression. In this case since we are regressing `Temp` against `Year`, the coefficient of `Year` will be an estimate of the yearly change in `Temp`. <br>
<br>
To streamline the process, we will define another function that calculates the average yearly change in temperature:
```python
from sklearn.linear_model import LinearRegression

def coef(data_group):
    """
    Determine the average yearly change in temperature for a given df
    Input:
        - data_group: usser-inputted df 
    """
    x = data_group[["Year"]] # 2 brackets because X needs to be a df
    y = data_group["Temp"]
    
    LR = LinearRegression()
    LR.fit(x, y)
    return round(LR.coef_[0], 4) # simple estimate of rate of change per year 
```
We are now set up to write a function that, when called, can answer our question. 
```python
def temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, **kwargs):
    """
    Interactive geographic scatterplot, constructed using Plotly Express,
    with a point for each station, such that the color of the point reflects 
    an estimate of the yearly change in temperature during the specified month 
    and time period at that station. 
    Input:
       - country, year_begin, year_end, and month should be as in the qurey_climate_database function
       - min_obs, the minimum required number of years of data for any given station
       - **kwargs, additional keyword arguments passed to px.scatter_mapbox(). 
                   these can be used to control the colormap used, the mapbox style, etc.
    """
    # obtain the df given the parameters specified by the user
    df = query_climate_database(country, year_begin, year_end, month)

    # filter our the stations that do not meet min_obs
    grouped_df = df.groupby("NAME")
    df = grouped_df.filter(lambda x: len(x) >= min_obs)
    
    # determine the average yearly change in temperature
    coefs = df.groupby(["NAME"]).apply(coef)
    
    # convert the coefs series to a df so that we can
    # merge it with the df of interest 
    coefs = coefs.to_frame()
    df = pd.merge(df, coefs, on = ["NAME"])
    
    # rename the coefs column in the new df 
    df = df.rename(columns = {df.columns[7] : "Estimated Yearly Increase (°C)"})
    
    fig = px.scatter_mapbox(df,
                            lat = "LATITUDE",
                            lon = "LONGITUDE",
                            hover_name = "NAME",
                            color = "Estimated Yearly Increase (°C)",
                            title = f"Estimates of yearly increase in temperature in {calendar.month_name[month]}<br>for stations in {country}, years {year_begin} - {year_end}",
                            **kwargs)
    return fig
```
Let's see our function in action with an example. Let's say we wanted to create a plot of estimated yearly increases in temperature during the month of January, in the interval 1980-2020, in India:
```python
# assumes you have imported necessary packages
color_map = px.colors.diverging.RdGy_r # choose a colormap

fig = temperature_coefficient_plot("India", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_scale=color_map)

fig.show()
```
{% include india_temp_coef_plot.html %}











